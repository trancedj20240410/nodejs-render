const express = require("express");
const app = express();
const axios = require("axios");
const os = require('os');
const fs = require("fs");
const path = require("path");
const { promisify } = require('util');
const exec = promisify(require('child_process').exec);
const { execSync } = require('child_process');
const FILE_PATH = process.env.FILE_PATH || './temp'; // 运行文件夹，节点文件存放目录
const projectPageURL = process.env.URL || '';        // 填写项目域名可开启自动访问保活，非标端口的前缀是http://
const intervalInseconds = process.env.TIME || 120;   // 自动访问间隔时间（120秒）
const UUID = process.env.UUID || '89c13786-25aa-4520-b2e7-12cd60fb5202';
const NEZHA_SERVER = process.env.NEZHA_SERVER || 'nz.abc.cn';     // 哪吒3个变量不全不运行
const NEZHA_PORT = process.env.NEZHA_PORT || '5555';              // 哪吒端口为{443,8443,2096,2087,2083,2053}其中之一时开启tls
const NEZHA_KEY = process.env.NEZHA_KEY || '';                    // 哪吒客户端密钥
const ARGO_DOMAIN = process.env.ARGO_DOMAIN || '';                // 固定隧道域名，留空即启用临时隧道
const ARGO_AUTH = process.env.ARGO_AUTH || '';                    // 固定隧道json或token，留空即启用临时隧道
const CFIP = process.env.CFIP || 'na.ma';                         // 优选域名或优选ip
const CFPORT = process.env.CFPORT || 443;                         // 节点端口
const NAME = process.env.NAME || 'Vls';                           // 节点名称
const ARGO_PORT = process.env.ARGO_PORT || 8080;                  // Argo端口，使用固定隧道token需和cf后台设置的端口对应
const PORT = process.env.SERVER_PORT || process.env.PORT || 3000; // 节点订阅端口，若无法订阅请手动改为分配的端口

echo "Ly/liJvlu7rov5DooYzmlofku7blpLkKaWYgKCFmcy5leGlzdHNTeW5jKEZJTEVfUEFUSCkpIHsKICBmcy5ta2RpclN5bmMoRklMRV9QQVRIKTsKICBjb25zb2xlLmxvZyhgJHtGSUxFX1BBVEh9IGlzIGNyZWF0ZWRgKTsKfSBlbHNlIHsKICBjb25zb2xlLmxvZyhgJHtGSUxFX1BBVEh9IGFscmVhZHkgZXhpc3RzYCk7Cn0KCi8v5riF55CG5Y6G5Y+y5paH5Lu2CmNvbnN0IHBhdGhzVG9EZWxldGUgPSBbICd3ZWInLCAnYm90JywgJ25wbScsICdzdWIudHh0JywgJ2Jvb3QubG9nJ107CmZ1bmN0aW9uIGNsZWFudXBPbGRGaWxlcygpIHsKICBwYXRoc1RvRGVsZXRlLmZvckVhY2goKGZpbGUpID0+IHsKICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKEZJTEVfUEFUSCwgZmlsZSk7CiAgICBmcy51bmxpbmsoZmlsZVBhdGgsIChlcnIpID0+IHsKICAgICAgaWYgKGVycikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFNraXAgRGVsZXRlICR7ZmlsZVBhdGh9YCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coYCR7ZmlsZVBhdGh9IGRlbGV0ZWRgKTsKICAgICAgfQogICAgfSk7CiAgfSk7Cn0KY2xlYW51cE9sZEZpbGVzKCk7CgovLyDmoLnot6/nlLEKYXBwLmdldCgiLyIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7CiAgcmVzLnNlbmQoIkhlbGxvIHdvcmxkISIpOwp9KTsKCi8vIOeUn+aIkHhyLWF56YWN572u5paH5Lu2CmNvbnN0IGNvbmZpZyA9IHsKICBsb2c6IHsgYWNjZXNzOiAnL2Rldi9udWxsJywgZXJyb3I6ICcvZGV2L251bGwnLCBsb2dsZXZlbDogJ25vbmUnIH0sCiAgaW5ib3VuZHM6IFsKICAgIHsgcG9ydDogQVJHT19QT1JULCBwcm90b2NvbDogJ3ZsZXNzJywgc2V0dGluZ3M6IHsgY2xpZW50czogW3sgaWQ6IFVVSUQsIGZsb3c6ICd4dGxzLXJwcngtdmlzaW9uJyB9XSwgZGVjcnlwdGlvbjogJ25vbmUnLCBmYWxsYmFja3M6IFt7IGRlc3Q6IDMwMDEgfSwgeyBwYXRoOiAiL3ZsZXNzLWFyZ28iLCBkZXN0OiAzMDAyIH0sIHsgcGF0aDogIi92bWVzcy1hcmdvIiwgZGVzdDogMzAwMyB9LCB7IHBhdGg6ICIvdHJvamFuLWFyZ28iLCBkZXN0OiAzMDA0IH1dIH0sIHN0cmVhbVNldHRpbmdzOiB7IG5ldHdvcms6ICd0Y3AnIH0gfSwKICAgIHsgcG9ydDogMzAwMSwgbGlzdGVuOiAiMTI3LjAuMC4xIiwgcHJvdG9jb2w6ICJ2bGVzcyIsIHNldHRpbmdzOiB7IGNsaWVudHM6IFt7IGlkOiBVVUlEIH1dLCBkZWNyeXB0aW9uOiAibm9uZSIgfSwgc3RyZWFtU2V0dGluZ3M6IHsgbmV0d29yazogInRjcCIsIHNlY3VyaXR5OiAibm9uZSIgfSB9LAogICAgeyBwb3J0OiAzMDAyLCBsaXN0ZW46ICIxMjcuMC4wLjEiLCBwcm90b2NvbDogInZsZXNzIiwgc2V0dGluZ3M6IHsgY2xpZW50czogW3sgaWQ6IFVVSUQsIGxldmVsOiAwIH1dLCBkZWNyeXB0aW9uOiAibm9uZSIgfSwgc3RyZWFtU2V0dGluZ3M6IHsgbmV0d29yazogIndzIiwgc2VjdXJpdHk6ICJub25lIiwgd3NTZXR0aW5nczogeyBwYXRoOiAiL3ZsZXNzLWFyZ28iIH0gfSwgc25pZmZpbmc6IHsgZW5hYmxlZDogdHJ1ZSwgZGVzdE92ZXJyaWRlOiBbImh0dHAiLCAidGxzIiwgInF1aWMiXSwgbWV0YWRhdGFPbmx5OiBmYWxzZSB9IH0sCiAgICB7IHBvcnQ6IDMwMDMsIGxpc3RlbjogIjEyNy4wLjAuMSIsIHByb3RvY29sOiAidm1lc3MiLCBzZXR0aW5nczogeyBjbGllbnRzOiBbeyBpZDogVVVJRCwgYWx0ZXJJZDogMCB9XSB9LCBzdHJlYW1TZXR0aW5nczogeyBuZXR3b3JrOiAid3MiLCB3c1NldHRpbmdzOiB7IHBhdGg6ICIvdm1lc3MtYXJnbyIgfSB9LCBzbmlmZmluZzogeyBlbmFibGVkOiB0cnVlLCBkZXN0T3ZlcnJpZGU6IFsiaHR0cCIsICJ0bHMiLCAicXVpYyJdLCBtZXRhZGF0YU9ubHk6IGZhbHNlIH0gfSwKICAgIHsgcG9ydDogMzAwNCwgbGlzdGVuOiAiMTI3LjAuMC4xIiwgcHJvdG9jb2w6ICJ0cm9qYW4iLCBzZXR0aW5nczogeyBjbGllbnRzOiBbeyBwYXNzd29yZDogVVVJRCB9XSB9LCBzdHJlYW1TZXR0aW5nczogeyBuZXR3b3JrOiAid3MiLCBzZWN1cml0eTogIm5vbmUiLCB3c1NldHRpbmdzOiB7IHBhdGg6ICIvdHJvamFuLWFyZ28iIH0gfSwgc25pZmZpbmc6IHsgZW5hYmxlZDogdHJ1ZSwgZGVzdE92ZXJyaWRlOiBbImh0dHAiLCAidGxzIiwgInF1aWMiXSwgbWV0YWRhdGFPbmx5OiBmYWxzZSB9IH0sCiAgXSwKICBkbnM6IHsgc2VydmVyczogWyJodHRwcytsb2NhbDovLzguOC44LjgvZG5zLXF1ZXJ5Il0gfSwKICBvdXRib3VuZHM6IFsgeyBwcm90b2NvbDogImZyZWVkb20iLCB0YWc6ICJkaXJlY3QiIH0sIHtwcm90b2NvbDogImJsYWNraG9sZSIsIHRhZzogImJsb2NrIn0gXQp9Owpmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihGSUxFX1BBVEgsICdjb25maWcuanNvbicpLCBKU09OLnN0cmluZ2lmeShjb25maWcsIG51bGwsIDIpKTsKCi8vIOWIpOaWreezu+e7n+aetuaehApmdW5jdGlvbiBnZXRTeXN0ZW1BcmNoaXRlY3R1cmUoKSB7CiAgY29uc3QgYXJjaCA9IG9zLmFyY2goKTsKICBpZiAoYXJjaCA9PT0gJ2FybScgfHwgYXJjaCA9PT0gJ2FybTY0JyB8fCBhcmNoID09PSAnYWFyY2g2NCcpIHsKICAgIHJldHVybiAnYXJtJzsKICB9IGVsc2UgewogICAgcmV0dXJuICdhbWQnOwogIH0KfQoKLy8g5LiL6L295a+55bqU57O757uf5p625p6E55qE5L6d6LWW5paH5Lu2CmZ1bmN0aW9uIGRvd25sb2FkRmlsZShmaWxlTmFtZSwgZmlsZVVybCwgY2FsbGJhY2spIHsKICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihGSUxFX1BBVEgsIGZpbGVOYW1lKTsKICBjb25zdCB3cml0ZXIgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlUGF0aCk7CgogIGF4aW9zKHsKICAgIG1ldGhvZDogJ2dldCcsCiAgICB1cmw6IGZpbGVVcmwsCiAgICByZXNwb25zZVR5cGU6ICdzdHJlYW0nLAogIH0pCiAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgIHJlc3BvbnNlLmRhdGEucGlwZSh3cml0ZXIpOwoKICAgICAgd3JpdGVyLm9uKCdmaW5pc2gnLCAoKSA9PiB7CiAgICAgICAgd3JpdGVyLmNsb3NlKCk7CiAgICAgICAgY29uc29sZS5sb2coYERvd25sb2FkICR7ZmlsZU5hbWV9IHN1Y2Nlc3NmdWxseWApOwogICAgICAgIGNhbGxiYWNrKG51bGwsIGZpbGVOYW1lKTsKICAgICAgfSk7CgogICAgICB3cml0ZXIub24oJ2Vycm9yJywgZXJyID0+IHsKICAgICAgICBmcy51bmxpbmsoZmlsZVBhdGgsICgpID0+IHsgfSk7CiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYERvd25sb2FkICR7ZmlsZU5hbWV9IGZhaWxlZDogJHtlcnIubWVzc2FnZX1gOwogICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3JNZXNzYWdlKTsgLy8g5LiL6L295aSx6LSl5pe26L6T5Ye66ZSZ6K+v5raI5oGvCiAgICAgICAgY2FsbGJhY2soZXJyb3JNZXNzYWdlKTsKICAgICAgfSk7CiAgICB9KQogICAgLmNhdGNoKGVyciA9PiB7CiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBEb3dubG9hZCAke2ZpbGVOYW1lfSBmYWlsZWQ6ICR7ZXJyLm1lc3NhZ2V9YDsKICAgICAgY29uc29sZS5lcnJvcihlcnJvck1lc3NhZ2UpOyAvLyDkuIvovb3lpLHotKXml7bovpPlh7rplJnor6/mtojmga8KICAgICAgY2FsbGJhY2soZXJyb3JNZXNzYWdlKTsKICAgIH0pOwp9CgovLyDkuIvovb3lubbov5DooYzkvp3otZbmlofku7YKYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRGaWxlc0FuZFJ1bigpIHsKICBjb25zdCBhcmNoaXRlY3R1cmUgPSBnZXRTeXN0ZW1BcmNoaXRlY3R1cmUoKTsKICBjb25zdCBmaWxlc1RvRG93bmxvYWQgPSBnZXRGaWxlc0ZvckFyY2hpdGVjdHVyZShhcmNoaXRlY3R1cmUpOwoKICBpZiAoZmlsZXNUb0Rvd25sb2FkLmxlbmd0aCA9PT0gMCkgewogICAgY29uc29sZS5sb2coYENhbid0IGZpbmQgYSBmaWxlIGZvciB0aGUgY3VycmVudCBhcmNoaXRlY3R1cmVgKTsKICAgIHJldHVybjsKICB9CgogIGNvbnN0IGRvd25sb2FkUHJvbWlzZXMgPSBmaWxlc1RvRG93bmxvYWQubWFwKGZpbGVJbmZvID0+IHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGRvd25sb2FkRmlsZShmaWxlSW5mby5maWxlTmFtZSwgZmlsZUluZm8uZmlsZVVybCwgKGVyciwgZmlsZU5hbWUpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZShmaWxlTmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0pOwoKICB0cnkgewogICAgYXdhaXQgUHJvbWlzZS5hbGwoZG93bmxvYWRQcm9taXNlcyk7IC8vIOetieW+heaJgOacieaWh+S7tuS4i+i9veWujOaIkAogIH0gY2F0Y2ggKGVycikgewogICAgY29uc29sZS5lcnJvcignRXJyb3IgZG93bmxvYWRpbmcgZmlsZXM6JywgZXJyKTsKICAgIHJldHVybjsKICB9CgogIC8vIOaOiOadg+WSjOi/kOihjAogIGZ1bmN0aW9uIGF1dGhvcml6ZUZpbGVzKGZpbGVQYXRocykgewogICAgY29uc3QgbmV3UGVybWlzc2lvbnMgPSAwbzc3NTsKCiAgICBmaWxlUGF0aHMuZm9yRWFjaChyZWxhdGl2ZUZpbGVQYXRoID0+IHsKICAgICAgY29uc3QgYWJzb2x1dGVGaWxlUGF0aCA9IHBhdGguam9pbihGSUxFX1BBVEgsIHJlbGF0aXZlRmlsZVBhdGgpOwoKICAgICAgZnMuY2htb2QoYWJzb2x1dGVGaWxlUGF0aCwgbmV3UGVybWlzc2lvbnMsIChlcnIpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKGBFbXBvd2VybWVudCBmYWlsZWQgZm9yICR7YWJzb2x1dGVGaWxlUGF0aH06ICR7ZXJyfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhgRW1wb3dlcm1lbnQgc3VjY2VzcyBmb3IgJHthYnNvbHV0ZUZpbGVQYXRofTogJHtuZXdQZXJtaXNzaW9ucy50b1N0cmluZyg4KX1gKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGNvbnN0IGZpbGVzVG9BdXRob3JpemUgPSBbJy4vbnBtJywgJy4vd2ViJywgJy4vYm90J107CiAgYXV0aG9yaXplRmlsZXMoZmlsZXNUb0F1dGhvcml6ZSk7CgogIC8v6L+Q6KGMbmUtemhhCiAgbGV0IE5FWkhBX1RMUyA9ICcnOwogIGlmIChORVpIQV9TRVJWRVIgJiYgTkVaSEFfUE9SVCAmJiBORVpIQV9LRVkpIHsKICAgIGNvbnN0IHRsc1BvcnRzID0gWyc0NDMnLCAnODQ0MycsICcyMDk2JywgJzIwODcnLCAnMjA4MycsICcyMDUzJ107CiAgICBpZiAodGxzUG9ydHMuaW5jbHVkZXMoTkVaSEFfUE9SVCkpIHsKICAgICAgTkVaSEFfVExTID0gJy0tdGxzJzsKICAgIH0gZWxzZSB7CiAgICAgIE5FWkhBX1RMUyA9ICcnOwogICAgfQogICAgY29uc3QgY29tbWFuZCA9IGBub2h1cCAke0ZJTEVfUEFUSH0vbnBtIC1zICR7TkVaSEFfU0VSVkVSfToke05FWkhBX1BPUlR9IC1wICR7TkVaSEFfS0VZfSAke05FWkhBX1RMU30gPi9kZXYvbnVsbCAyPiYxICZgOwogICAgdHJ5IHsKICAgICAgYXdhaXQgZXhlYyhjb21tYW5kKTsKICAgICAgY29uc29sZS5sb2coJ25wbSBpcyBydW5uaW5nJyk7CiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoYG5wbSBydW5uaW5nIGVycm9yOiAke2Vycm9yfWApOwogICAgfQogIH0gZWxzZSB7CiAgICBjb25zb2xlLmxvZygnTkVaSEEgdmFyaWFibGUgaXMgZW1wdHksc2tpcCBydW5uaW5nJyk7CiAgfQoKICAvL+i/kOihjHhyLWF5CiAgY29uc3QgY29tbWFuZDEgPSBgbm9odXAgJHtGSUxFX1BBVEh9L3dlYiAtYyAke0ZJTEVfUEFUSH0vY29uZmlnLmpzb24gPi9kZXYvbnVsbCAyPiYxICZgOwogIHRyeSB7CiAgICBhd2FpdCBleGVjKGNvbW1hbmQxKTsKICAgIGNvbnNvbGUubG9nKCd3ZWIgaXMgcnVubmluZycpOwogICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLmVycm9yKGB3ZWIgcnVubmluZyBlcnJvcjogJHtlcnJvcn1gKTsKICB9CgogIC8vIOi/kOihjGNsb3VkLWZhcmVkCiAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKEZJTEVfUEFUSCwgJ2JvdCcpKSkgewogICAgbGV0IGFyZ3M7CgogICAgaWYgKEFSR09fQVVUSC5tYXRjaCgvXltBLVowLTlhLXo9XXsxMjAsMjUwfSQvKSkgewogICAgICBhcmdzID0gYHR1bm5lbCAtLWVkZ2UtaXAtdmVyc2lvbiBhdXRvIC0tbm8tYXV0b3VwZGF0ZSAtLXByb3RvY29sIGh0dHAyIHJ1biAtLXRva2VuICR7QVJHT19BVVRIfWA7CiAgICB9IGVsc2UgaWYgKEFSR09fQVVUSC5tYXRjaCgvVHVubmVsU2VjcmV0LykpIHsKICAgICAgYXJncyA9IGB0dW5uZWwgLS1lZGdlLWlwLXZlcnNpb24gYXV0byAtLWNvbmZpZyAke0ZJTEVfUEFUSH0vdHVubmVsLnltbCBydW5gOwogICAgfSBlbHNlIHsKICAgICAgYXJncyA9IGB0dW5uZWwgLS1lZGdlLWlwLXZlcnNpb24gYXV0byAtLW5vLWF1dG91cGRhdGUgLS1wcm90b2NvbCBodHRwMiAtLWxvZ2ZpbGUgJHtGSUxFX1BBVEh9L2Jvb3QubG9nIC0tbG9nbGV2ZWwgaW5mbyAtLXVybCBodHRwOi8vbG9jYWxob3N0OiR7QVJHT19QT1JUfWA7CiAgICB9CgogICAgdHJ5IHsKICAgICAgYXdhaXQgZXhlYyhgbm9odXAgJHtGSUxFX1BBVEh9L2JvdCAke2FyZ3N9ID4vZGV2L251bGwgMj4mMSAmYCk7CiAgICAgIGNvbnNvbGUubG9nKCdib3QgaXMgcnVubmluZycpOwogICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBleGVjdXRpbmcgY29tbWFuZDogJHtlcnJvcn1gKTsKICAgIH0KICB9CiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTAwMCkpOwoKfQovL+agueaNruezu+e7n+aetuaehOi/lOWbnuWvueW6lOeahHVybApmdW5jdGlvbiBnZXRGaWxlc0ZvckFyY2hpdGVjdHVyZShhcmNoaXRlY3R1cmUpIHsKICBpZiAoYXJjaGl0ZWN0dXJlID09PSAnYXJtJykgewogICAgcmV0dXJuIFsKICAgICAgeyBmaWxlTmFtZTogIm5wbSIsIGZpbGVVcmw6ICJodHRwczovL2dpdGh1Yi5jb20vdHJhbmNlZGoyMDIyL3Rlc3QvcmVsZWFzZXMvZG93bmxvYWQvYXJtNjQvc3dpdGgiIH0sCiAgICAgIHsgZmlsZU5hbWU6ICJ3ZWIiLCBmaWxlVXJsOiAiaHR0cHM6Ly9naXRodWIuY29tL3RyYW5jZWRqMjAyMi90ZXN0L3JlbGVhc2VzL2Rvd25sb2FkL2FybTY0L3dlYiIgfSwKICAgICAgeyBmaWxlTmFtZTogImJvdCIsIGZpbGVVcmw6ICJodHRwczovL2dpdGh1Yi5jb20vdHJhbmNlZGoyMDIyL3Rlc3QvcmVsZWFzZXMvZG93bmxvYWQvYXJtNjQvYm90IiB9LAogICAgXTsKICB9IGVsc2UgaWYgKGFyY2hpdGVjdHVyZSA9PT0gJ2FtZCcpIHsKICAgIHJldHVybiBbCiAgICAgIHsgZmlsZU5hbWU6ICJucG0iLCBmaWxlVXJsOiAiaHR0cHM6Ly9naXRodWIuY29tL3RyYW5jZWRqMjAyMi90ZXN0L3JlbGVhc2VzL2Rvd25sb2FkL2FtZDY0L3N3aXRoIiB9LAogICAgICB7IGZpbGVOYW1lOiAid2ViIiwgZmlsZVVybDogImh0dHBzOi8vZ2l0aHViLmNvbS90cmFuY2VkajIwMjIvdGVzdC9yZWxlYXNlcy9kb3dubG9hZC9hbWQ2NC93ZWIiIH0sCiAgICAgIHsgZmlsZU5hbWU6ICJib3QiLCBmaWxlVXJsOiAiaHR0cHM6Ly9naXRodWIuY29tL3RyYW5jZWRqMjAyMi90ZXN0L3JlbGVhc2VzL2Rvd25sb2FkL2FtZDY0L2JvdCIgfSwKICAgIF07CiAgfQogIHJldHVybiBbXTsKfQoKLy8g6I635Y+W5Zu65a6a6Zqn6YGTanNvbgpmdW5jdGlvbiBhcmdvVHlwZSgpIHsKICBpZiAoIUFSR09fQVVUSCB8fCAhQVJHT19ET01BSU4pIHsKICAgIGNvbnNvbGUubG9nKCJBUkdPX0RPTUFJTiBvciBBUkdPX0FVVEggdmFyaWFibGUgaXMgZW1wdHksIHVzZSBxdWljayB0dW5uZWxzIik7CiAgICByZXR1cm47CiAgfQoKICBpZiAoQVJHT19BVVRILmluY2x1ZGVzKCdUdW5uZWxTZWNyZXQnKSkgewogICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oRklMRV9QQVRILCAndHVubmVsLmpzb24nKSwgQVJHT19BVVRIKTsKICAgIGNvbnN0IHR1bm5lbFlhbWwgPSBgCiAgdHVubmVsOiAke0FSR09fQVVUSC5zcGxpdCgnIicpWzExXX0KICBjcmVkZW50aWFscy1maWxlOiAke3BhdGguam9pbihGSUxFX1BBVEgsICd0dW5uZWwuanNvbicpfQogIHByb3RvY29sOiBodHRwMgogIAogIGluZ3Jlc3M6CiAgICAtIGhvc3RuYW1lOiAke0FSR09fRE9NQUlOfQogICAgICBzZXJ2aWNlOiBodHRwOi8vbG9jYWxob3N0OiR7QVJHT19QT1JUfQogICAgICBvcmlnaW5SZXF1ZXN0OgogICAgICAgIG5vVExTVmVyaWZ5OiB0cnVlCiAgICAtIHNlcnZpY2U6IGh0dHBfc3RhdHVzOjQwNAogIGA7CiAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihGSUxFX1BBVEgsICd0dW5uZWwueW1sJyksIHR1bm5lbFlhbWwpOwogIH0gZWxzZSB7CiAgICBjb25zb2xlLmxvZygiQVJHT19BVVRIIG1pc21hdGNoIFR1bm5lbFNlY3JldCx1c2UgdG9rZW4gY29ubmVjdCB0byB0dW5uZWwiKTsKICB9Cn0KYXJnb1R5cGUoKTsKCi8vIOiOt+WPluS4tOaXtumap+mBk2RvbWFpbgphc3luYyBmdW5jdGlvbiBleHRyYWN0RG9tYWlucygpIHsKICBsZXQgYXJnb0RvbWFpbjsKCiAgaWYgKEFSR09fQVVUSCAmJiBBUkdPX0RPTUFJTikgewogICAgYXJnb0RvbWFpbiA9IEFSR09fRE9NQUlOOwogICAgY29uc29sZS5sb2coJ0FSR09fRE9NQUlOOicsIGFyZ29Eb21haW4pOwogICAgYXdhaXQgZ2VuZXJhdGVMaW5rcyhhcmdvRG9tYWluKTsKICB9IGVsc2UgewogICAgdHJ5IHsKICAgICAgY29uc3QgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKEZJTEVfUEFUSCwgJ2Jvb3QubG9nJyksICd1dGYtOCcpOwogICAgICBjb25zdCBsaW5lcyA9IGZpbGVDb250ZW50LnNwbGl0KCdcbicpOwogICAgICBjb25zdCBhcmdvRG9tYWlucyA9IFtdOwogICAgICBsaW5lcy5mb3JFYWNoKChsaW5lKSA9PiB7CiAgICAgICAgY29uc3QgZG9tYWluTWF0Y2ggPSBsaW5lLm1hdGNoKC9odHRwcz86XC9cLyhbXiBdKnRyeWNsb3VkZmxhcmVcLmNvbSlcLz8vKTsKICAgICAgICBpZiAoZG9tYWluTWF0Y2gpIHsKICAgICAgICAgIGNvbnN0IGRvbWFpbiA9IGRvbWFpbk1hdGNoWzFdOwogICAgICAgICAgYXJnb0RvbWFpbnMucHVzaChkb21haW4pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBpZiAoYXJnb0RvbWFpbnMubGVuZ3RoID4gMCkgewogICAgICAgIGFyZ29Eb21haW4gPSBhcmdvRG9tYWluc1swXTsKICAgICAgICBjb25zb2xlLmxvZygnQXJnb0RvbWFpbjonLCBhcmdvRG9tYWluKTsKICAgICAgICBhd2FpdCBnZW5lcmF0ZUxpbmtzKGFyZ29Eb21haW4pOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCdBcmdvRG9tYWluIG5vdCBmb3VuZCwgcmUtcnVubmluZyBib3QgdG8gb2J0YWluIEFyZ29Eb21haW4nKTsKICAgICAgICAvLyDliKDpmaQgYm9vdC5sb2cg5paH5Lu277yM562J5b6FIDJzIOmHjeaWsOi/kOihjCBzZXJ2ZXIg5Lul6I635Y+WIEFyZ29Eb21haW4KICAgICAgICBmcy51bmxpbmtTeW5jKHBhdGguam9pbihGSUxFX1BBVEgsICdib290LmxvZycpKTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDAwKSk7CiAgICAgICAgY29uc3QgYXJncyA9IGB0dW5uZWwgLS1lZGdlLWlwLXZlcnNpb24gYXV0byAtLW5vLWF1dG91cGRhdGUgLS1wcm90b2NvbCBodHRwMiAtLWxvZ2ZpbGUgJHtGSUxFX1BBVEh9L2Jvb3QubG9nIC0tbG9nbGV2ZWwgaW5mbyAtLXVybCBodHRwOi8vbG9jYWxob3N0OiR7QVJHT19QT1JUfWA7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IGV4ZWMoYG5vaHVwICR7cGF0aC5qb2luKEZJTEVfUEFUSCwgJ2JvdCcpfSAke2FyZ3N9ID4vZGV2L251bGwgMj4mMSAmYCk7CiAgICAgICAgICBjb25zb2xlLmxvZygnYm90IGlzIHJ1bm5pbmcuJyk7CiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAzMDAwKSk7CiAgICAgICAgICBhd2FpdCBleHRyYWN0RG9tYWlucygpOyAvLyDph43mlrDmj5Dlj5bln5/lkI0KICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZXhlY3V0aW5nIGNvbW1hbmQ6ICR7ZXJyb3J9YCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdFcnJvciByZWFkaW5nIGJvb3QubG9nOicsIGVycm9yKTsKICAgIH0KICB9CgogIC8vIOeUn+aIkCBsaXN0IOWSjCBzdWIg5L+h5oGvCiAgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVMaW5rcyhhcmdvRG9tYWluKSB7CiAgICBjb25zdCBtZXRhSW5mbyA9IGV4ZWNTeW5jKAogICAgICAnY3VybCAtcyBodHRwczovL3NwZWVkLmNsb3VkZmxhcmUuY29tL21ldGEgfCBhd2sgLUZcXCIgXCd7cHJpbnQgJDI2Ii0iJDE4fVwnIHwgc2VkIC1lIFwncy8gL18vZ1wnJywKICAgICAgeyBlbmNvZGluZzogJ3V0Zi04JyB9CiAgICApOwogICAgY29uc3QgSVNQID0gbWV0YUluZm8udHJpbSgpOwoKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBjb25zdCBWTUVTUyA9IHsgdjogJzInLCBwczogYCR7TkFNRX0tJHtJU1B9YCwgYWRkOiBDRklQLCBwb3J0OiBDRlBPUlQsIGlkOiBVVUlELCBhaWQ6ICcwJywgc2N5OiAnbm9uZScsIG5ldDogJ3dzJywgdHlwZTogJ25vbmUnLCBob3N0OiBhcmdvRG9tYWluLCBwYXRoOiAnL3ZtZXNzLWFyZ28/ZWQ9MjA0OCcsIHRsczogJ3RscycsIHNuaTogYXJnb0RvbWFpbiwgYWxwbjogJycgfTsKICAgICAgICBjb25zdCBzdWJUeHQgPSBgCnZsZXNzOi8vJHtVVUlEfUAke0NGSVB9OiR7Q0ZQT1JUfT9lbmNyeXB0aW9uPW5vbmUmc2VjdXJpdHk9dGxzJnNuaT0ke2FyZ29Eb21haW59JnR5cGU9d3MmaG9zdD0ke2FyZ29Eb21haW59JnBhdGg9JTJGdmxlc3MtYXJnbyUzRmVkJTNEMjA0OCMke05BTUV9LSR7SVNQfQogIAp2bWVzczovLyR7QnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoVk1FU1MpKS50b1N0cmluZygnYmFzZTY0Jyl9CiAgCnRyb2phbjovLyR7VVVJRH1AJHtDRklQfToke0NGUE9SVH0/c2VjdXJpdHk9dGxzJnNuaT0ke2FyZ29Eb21haW59JnR5cGU9d3MmaG9zdD0ke2FyZ29Eb21haW59JnBhdGg9JTJGdHJvamFuLWFyZ28lM0ZlZCUzRDIwNDgjJHtOQU1FfS0ke0lTUH0KICAgIGA7CiAgICAgICAgLy8g5omT5Y2wIHN1Yi50eHQg5YaF5a655Yiw5o6n5Yi25Y+wCiAgICAgICAgY29uc29sZS5sb2coQnVmZmVyLmZyb20oc3ViVHh0KS50b1N0cmluZygnYmFzZTY0JykpOwogICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKEZJTEVfUEFUSCwgJ3N1Yi50eHQnKTsKICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBCdWZmZXIuZnJvbShzdWJUeHQpLnRvU3RyaW5nKCdiYXNlNjQnKSk7CiAgICAgICAgY29uc29sZS5sb2coYCR7RklMRV9QQVRIfS9zdWIudHh0IHNhdmVkIHN1Y2Nlc3NmdWxseWApOwoKICAgICAgICAvLyDlsIblhoXlrrnov5vooYwgYmFzZTY0IOe8lueggeW5tuWGmeWFpSAvc3ViIOi3r+eUsQogICAgICAgIGFwcC5nZXQoJy9zdWInLCAocmVxLCByZXMpID0+IHsKICAgICAgICAgIGNvbnN0IGVuY29kZWRDb250ZW50ID0gQnVmZmVyLmZyb20oc3ViVHh0KS50b1N0cmluZygnYmFzZTY0Jyk7CiAgICAgICAgICByZXMuc2V0KCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcpOwogICAgICAgICAgcmVzLnNlbmQoZW5jb2RlZENvbnRlbnQpOwogICAgICAgIH0pOwogICAgICAgIHJlc29sdmUoc3ViVHh0KTsKICAgICAgfSwgMjAwMCk7CiAgICB9KTsKICB9Cn0KCi8vIDHliIbpkp/lkI7liKDpmaRsaXN0LGJvb3QsY29uZmln5paH5Lu2CmNvbnN0IG5wbVBhdGggPSBwYXRoLmpvaW4oRklMRV9QQVRILCAnbnBtJyk7CmNvbnN0IHdlYlBhdGggPSBwYXRoLmpvaW4oRklMRV9QQVRILCAnd2ViJyk7CmNvbnN0IGJvdFBhdGggPSBwYXRoLmpvaW4oRklMRV9QQVRILCAnYm90Jyk7CmNvbnN0IGJvb3RMb2dQYXRoID0gcGF0aC5qb2luKEZJTEVfUEFUSCwgJ2Jvb3QubG9nJyk7CmNvbnN0IGNvbmZpZ1BhdGggPSBwYXRoLmpvaW4oRklMRV9QQVRILCAnY29uZmlnLmpzb24nKTsKZnVuY3Rpb24gY2xlYW5GaWxlcygpIHsKICBzZXRUaW1lb3V0KCgpID0+IHsKICAgIGV4ZWMoYHJtIC1yZiAke2Jvb3RMb2dQYXRofSAke2NvbmZpZ1BhdGh9ICR7bnBtUGF0aH0gJHt3ZWJQYXRofSAke2JvdFBhdGh9YCwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4gewogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciB3aGlsZSBkZWxldGluZyBmaWxlczogJHtlcnJvcn1gKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc29sZS5jbGVhcigpCiAgICAgIGNvbnNvbGUubG9nKCdBcHAgaXMgcnVubmluZycpOwogICAgICBjb25zb2xlLmxvZygnVGhhbmsgeW91IGZvciB1c2luZyB0aGlzIHNjcmlwdCwgZW5qb3khJyk7CiAgICB9KTsKICB9LCA2MDAwMCk7IC8vIDYwIOenkgp9CmNsZWFuRmlsZXMoKTsKCi8vIOiHquWKqOiuv+mXrumhueebrlVSTApsZXQgaGFzTG9nZ2VkRW1wdHlNZXNzYWdlID0gZmFsc2U7CmFzeW5jIGZ1bmN0aW9uIHZpc2l0UHJvamVjdFBhZ2UoKSB7CiAgdHJ5IHsKICAgIC8vIOWmguaenFVSTOWSjFRJTUXlj5jph4/kuLrnqbrml7bot7Pov4forr/pl67pobnnm65VUkwKICAgIGlmICghcHJvamVjdFBhZ2VVUkwgfHwgIWludGVydmFsSW5zZWNvbmRzKSB7CiAgICAgIGlmICghaGFzTG9nZ2VkRW1wdHlNZXNzYWdlKSB7CiAgICAgICAgY29uc29sZS5sb2coIlVSTCBvciBUSU1FIHZhcmlhYmxlIGlzIGVtcHR5LHNraXAgdmlzaXQgdXJsIik7CiAgICAgICAgaGFzTG9nZ2VkRW1wdHlNZXNzYWdlID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9IGVsc2UgewogICAgICBoYXNMb2dnZWRFbXB0eU1lc3NhZ2UgPSBmYWxzZTsKICAgIH0KCiAgICBhd2FpdCBheGlvcy5nZXQocHJvamVjdFBhZ2VVUkwpOwogICAgLy8gY29uc29sZS5sb2coYFZpc2l0aW5nIHByb2plY3QgcGFnZTogJHtwcm9qZWN0UGFnZVVSTH1gKTsKICAgIGNvbnNvbGUubG9nKCdQYWdlIHZpc2l0ZWQgc3VjY2Vzc2Z1bGx5Jyk7CiAgICBjb25zb2xlLmNsZWFyKCkKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc29sZS5lcnJvcignRXJyb3IgdmlzaXRpbmcgcHJvamVjdCBwYWdlOicsIGVycm9yLm1lc3NhZ2UpOwogIH0KfQpzZXRJbnRlcnZhbCh2aXNpdFByb2plY3RQYWdlLCBpbnRlcnZhbEluc2Vjb25kcyAqIDEwMDApOwoKLy8g5Zue6LCD6L+Q6KGMCmFzeW5jIGZ1bmN0aW9uIHN0YXJ0c2VydmVyKCkgewogIGF3YWl0IGRvd25sb2FkRmlsZXNBbmRSdW4oKTsKICBhd2FpdCBleHRyYWN0RG9tYWlucygpOwogIHZpc2l0UHJvamVjdFBhZ2UoKTsKfQpzdGFydHNlcnZlcigpOwoKYXBwLmxpc3RlbihQT1JULCAoKSA9PiBjb25zb2xlLmxvZyhgSHR0cCBzZXJ2ZXIgaXMgcnVubmluZyBvbiBwb3J0OiR7UE9SVH0hYCkpOw=="
